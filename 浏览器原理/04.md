### 04 导航流程： 从输入URL 到界面展示，这中间发生了什么？

![image-20210301171140670](/Users/rys/Library/Application Support/typora-user-images/image-20210301171140670.png)

- 浏览器进程主要负责用户交互、子进程管理和文件储存等功能。

- 网络进程是面向渲染进程和浏览器进程等提供网络下载功能

- 渲染进程的主要职责是把从网络下载的HTML、Javascript、CSS、图片等资源等解析为可以显示和交互的界面。因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的，是运行在沙箱里的，就是为了保证系统的安全。

  用户发出 URL 请求到页面开始解析的这个过程，这叫做导航。

  #### 从输入 URL 到 页面展示

  1. 用户输入：

     - 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 url
     - 如果输入内容符合URL 规则，那么地址栏会根据规则，把内容加上协议，合成完整的 URL.

  2. URL 请求过程

     浏览器通过 IPC  把网络请求发送到网络进程，网络进程去发起真正的URL 请求。

     1. 网络进程会查找本地缓存是否有，有则返回缓存资源，没有则进入网络请求流程，第一步是进行DNS解析，获取请求域名的服务器IP地址，如果协议是HTTPS,需要建立TLS 连接。
     2. 利用IP地址和服务器建立TCP连接，浏览器发送request message,服务器 responese message.

     

     ##### (1)  重定向

     ![image-20210301184842272](/Users/rys/Library/Application Support/typora-user-images/image-20210301184842272.png)

     

     在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回 的状态码是 301/302,那么说明服务器需要浏览器重定向到其他URL,这时候网络进程会从响应头的Location字段里读取重定向地址，然后再发起新的HTTP/HTTPS请求，一切又重头开始了。

  在导航过程中，如果服务器响应行的状态码包括301、302一类的跳转信息，浏览器会跳转到新的地址继续导航；如果响应行是200，那么表示浏览器可以继续处理该请求。

  

  ### （2）响应数据类型处理

  通过`Content-Type` 字段的值来做响应数据的处理，如果为 application/octet-stream, 那么该请求会被提交到浏览器的下载管理器，同时该URL 请求的导航流程到此结束，如果是HTML,那么浏览器则会继续处理导航流程。

  #### （3）准备渲染流程

  渲染进程策略：

  1. 通常情况下，打开新的页面都会有单独的渲染进程；
  2. 如果从 A 页面打开 B页面，且 A和B 都属于 `同一站点` 的话，那么 B页面复用 A 页面的渲染进程；如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

  #### （4） 提交文档

  所谓提交文档，就是指浏览器进程将网络进程接收到的HTML数据提交到渲染进程，具体流程是这样的：

  1. 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息；

  2. 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”

  3. 当文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；

  4. 浏览器进程在接收到“确认提交” 的消息后，会更新浏览器界面的状态，包括了，安全状态，地址栏的URL, 前进后退的历史状态，并更新 web 页面。

     ![image-20210301202215536](/Users/rys/Library/Application Support/typora-user-images/image-20210301202215536.png)

  #### (5).  渲染阶段

  文档被提交后，渲染进程便开始页面解析和子资源加载了。



#### 评论精选：

1. 用户在浏览器输入URL之后，发生了什么？

答： 1）浏览器检查是否是URL协议，如果是，则组装协议，拼成完整的URL，如果不是，则用默认引擎去搜索

2）浏览器进程通过进程间通信（IPC）把 URL请求发送给 网络进程

3）网络进程接收到 URL 请求后检查本地缓存是否缓存了该请求资源，如果有，则将该资源返回给浏览器进程。如果没有缓存，则网络进程向服务器发起 HTTP请求，请求流程如下：

- 进行DNS解析，获取到服务器的ip地址和端口号
- 利用ip地址和服务器建立 TCP 连接；
- 构建和发送请求头信息
- 服务端响应后，网络进程接收响应头和响应信息，并解析响应内容。

4)  网络进程解析响应流程；

       1.  检查状态码： 301/302，如果需要重定向，则从 Location 自动 中读取地址，重新进行第 3步
          2.  200响应的处理，检查Content-Type,字节流类型，则将该请求提交给下载管理器，该导航流程结束，不再进行；如果是 html类型，则通知浏览器进程通知渲染进程准备进行渲染。

5） 准备渲染进程  => 浏览器进程检查当前 URL是否和之前打开的渲染进程根域名是否相同，如果相同，则复用原来的进程，如果不同，则开启新的渲染进程。

6） 传输数据、更新状态

1. 渲染进程准备好后，浏览器向渲染进程发起 “提交文档”的消息，渲染进程接收到消息后，和网络进程建立起数据传输的管道
2. 渲染进程接收完数据后，向浏览器发送 “确认提交”的消息
3. 浏览器进程接收到确认消息后更新浏览器界面状态：安全、地址栏 URL、前进后退的历史状态、更新 web 页面。

2.  答：

   ```markdown
   1. 用户输入URL，浏览器会根据用户输入的信息判断是搜索还是网址，如果是搜索内容，就将搜索内容+默认搜索引擎合成新的URL；如果用户输入的内容符合URL规则，浏览器就会根据URL协议，在这段内容上加上协议合成合法的URL
   2. 用户输入完内容，按下回车键，浏览器导航栏显示loading状态，但是页面还是呈现前一个页面，这是因为新页面的响应数据还没有获得
   3. 浏览器进程浏览器构建请求行信息，会通过进程间通信（IPC）将URL请求发送给网络进程
   
   GET /index.html HTTP1.1
   
   4. 网络进程获取到URL，先去本地缓存中查找是否有缓存文件，如果有，拦截请求，直接200返回；否则，进入网络请求过程
   5. 网络进程请求DNS返回域名对应的IP和端口号，如果之前DNS数据缓存服务缓存过当前域名信息，就会直接返回缓存信息；否则，发起请求获取根据域名解析出来的IP和端口号，如果没有端口号，http默认80，https默认443。如果是https请求，还需要建立TLS连接。
   6. Chrome 有个机制，同一个域名同时最多只能建立 6 个TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。如果当前请求数量少于6个，会直接建立TCP连接。
   7. TCP三次握手建立连接，http请求加上TCP头部——包括源端口号、目的程序端口号和用于校验数据完整性的序号，向下传输
   8. 网络层在数据包上加上IP头部——包括源IP地址和目的IP地址，继续向下传输到底层
   9. 底层通过物理网络传输给目的服务器主机
   10. 目的服务器主机网络层接收到数据包，解析出IP头部，识别出数据部分，将解开的数据包向上传输到传输层
   11. 目的服务器主机传输层获取到数据包，解析出TCP头部，识别端口，将解开的数据包向上传输到应用层
   12. 应用层HTTP解析请求头和请求体，如果需要重定向，HTTP直接返回HTTP响应数据的状态code301或者302，同时在请求头的Location字段中附上重定向地址，浏览器会根据code和Location进行重定向操作；如果不是重定向，首先服务器会根据 请求头中的If-None-Match 的值来判断请求的资源是否被更新，如果没有更新，就返回304状态码，相当于告诉浏览器之前的缓存还可以使用，就不返回新数据了；否则，返回新数据，200的状态码，并且如果想要浏览器缓存数据的话，就在相应头中加入字段：
   Cache-Control:Max-age=2000
   响应数据又顺着应用层——传输层——网络层——网络层——传输层——应用层的顺序返回到网络进程
   13. 数据传输完成，TCP四次挥手断开连接。如果，浏览器或者服务器在HTTP头部加上如下信息，TCP就一直保持连接。保持TCP连接可以省下下次需要建立连接的时间，提示资源加载速度
   Connection:Keep-Alive
   14. 网络进程将获取到的数据包进行解析，根据响应头中的Content-type来判断响应数据的类型，如果是字节流类型，就将该请求交给下载管理器，该导航流程结束，不再进行；如果是text/html类型，就通知浏览器进程获取到文档准备渲染
   15. 浏览器进程获取到通知，根据当前页面B是否是从页面A打开的并且和页面A是否是同一个站点（根域名和协议一样就被认为是同一个站点），如果满足上述条件，就复用之前网页的进程，否则，新创建一个单独的渲染进程
   16. 浏览器会发出“提交文档”的消息给渲染进程，渲染进程收到消息后，会和网络进程建立传输数据的“管道”，文档数据传输完成后，渲染进程会返回“确认提交”的消息给浏览器进程
   17. 浏览器收到“确认提交”的消息后，会更新浏览器的页面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新web页面，此时的web页面是空白页
   18. 渲染进程对文档进行页面解析和子资源加载，HTML 通过HTM 解析器转成DOM Tree（二叉树类似结构的东西），CSS按照CSS 规则和CSS解释器转成CSSOM TREE，两个tree结合，形成render tree（不包含HTML的具体元素和元素要画的具体位置），通过Layout可以计算出每个元素具体的宽高颜色位置，结合起来，开始绘制，最后显示在屏幕中新页面显示出来
   ```

   

